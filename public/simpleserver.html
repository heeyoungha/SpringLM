<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple HTTP Server - 1단계</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">

    <main>
        <section class="feature">
            <h2>구현된 기능</h2>
            <ul>
                <li>ServerSocket을 사용한 서버 시작 및 클라이언트 연결 처리</li>
                <li>HTTP 요청 파싱 (GET 지원)</li>
                <li>정적 파일 서비스 (HTML, CSS, JS)</li>
                <li>HTTP 상태 코드 반환 (200 OK, 404 Not Found)</li>
                <li>기본적인 라우팅 처리</li>
                <li>QueryString 파싱 및 파라미터 추출</li>
            </ul>

            <h3>실제 서버 응답 확인</h3>
            <div class="server-response">
                <div class="response-controls">
                    <button id="testRequest" class="test-btn">서버 응답 테스트</button>
                    <select id="testPath" class="test-select">
                        <option value="/">루트 (/)</option>
                        <option value="/simpleserver.html">simpleserver.html</option>
                        <option value="/style.css">style.css</option>
                        <option value="/nonexistent.txt">존재하지 않는 파일</option>
                        <option value="/simpleserver.html?name=test&age=25">QueryString 테스트 1</option>
                        <option value="/simpleserver.html?category=server&type=http&version=1.0">QueryString 테스트 2</option>
                        <option value="/style.css?theme=dark&font=large">QueryString 테스트 3</option>
                    </select>
                </div>
                
                <div class="response-display">
                    <h4>실제 서버 응답</h4>
                    <div id="responseOutput" class="response-output">
                        <p class="placeholder">위의 "서버 응답 테스트" 버튼을 클릭하여 실제 응답을 확인하세요.</p>
                    </div>
                </div>
                
                <div class="response-details">
                    <h4>응답 구조 설명</h4>
                    <ul>
                        <li><strong>Status Line</strong>: HTTP 프로토콜 버전과 상태 코드</li>
                        <li><strong>Headers</strong>: Content-Type, Content-Length 등 메타데이터</li>
                        <li><strong>Empty Line</strong>: 헤더와 본문을 구분하는 빈 줄</li>
                        <li><strong>Body</strong>: 실제 파일 내용 또는 에러 메시지의 상위 5줄 표시</li>
                    </ul>
                    
                    <h4>QueryString 파싱 기능</h4>
                    <ul>
                        <li><strong>URL 파라미터 추출</strong>: <code>?key=value&key2=value2</code> 형태 파싱</li>
                        <li><strong>키-값 분리</strong>: <code>&</code>로 구분된 파라미터들을 개별적으로 처리</li>
                        <li><strong>서버 콘솔 출력</strong>: 파싱된 파라미터를 서버 콘솔에 로그로 출력</li>
                        <li><strong>경로 정리</strong>: QueryString을 제거한 순수 경로로 파일 서비스</li>
                    </ul>
                </div>
            </div>
        </section>

    </main>

    <footer>
        <p>Spring LoadMap 프로젝트 - 1단계</p>
    </footer>
</div>
    <script>
        // HTTP 응답 테스트 기능 초기화
        initHttpTest();

        // HTTP 응답 테스트 기능 초기화
        function initHttpTest() {
            const testBtn = document.getElementById('testRequest');
            const testPath = document.getElementById('testPath');
            const responseOutput = document.getElementById('responseOutput');

            testBtn.addEventListener('click', async function() {
                const selectedPath = testPath.value;
                testBtn.disabled = true;
                testBtn.textContent = '요청 중...';

                try {
                    const response = await testHttpRequest(selectedPath);
                    displayHttpResponse(response, selectedPath);
                } catch (error) {
                    responseOutput.innerHTML = `
                    <div class="error-response">
                        <h5>요청 실패</h5>
                        <p>${error.message}</p>
                        <p>서버가 실행 중인지 확인해주세요. (포트 8080)</p>
                    </div>
                `;
                } finally {
                    testBtn.disabled = false;
                    testBtn.textContent = '서버 응답 테스트';
                }
            });
        }

    // HTTP 요청 테스트 함수
    async function testHttpRequest(path) {
        const response = await fetch(`http://localhost:8080${path}`, {
            method: 'GET',
            mode: 'cors'
        });

        // 응답 헤더 정보 수집
        const headers = {};
        response.headers.forEach((value, key) => {
            headers[key] = value;
        });

        // 응답 본문 읽기
        const body = await response.text();

        return {
            status: response.status,
            statusText: response.statusText,
            headers: headers,
            body: body,
            url: response.url
        };
    }

    // HTTP 응답 표시 함수
    function displayHttpResponse(response, requestedPath) {
        const responseOutput = document.getElementById('responseOutput');

        // 응답 본문을 5줄로 제한
        const bodyLines = response.body.split('\n');
        const limitedBody = bodyLines.length > 5 
            ? bodyLines.slice(0, 5).join('\n') + '\n...'
            : response.body;

        // HTTP 응답 형식으로 표시
        const httpResponse = `HTTP/1.1 ${response.status} ${response.statusText}
${Object.entries(response.headers).map(([key, value]) => `${key}: ${value}`).join('\n')}

${limitedBody}`;

        responseOutput.innerHTML = `<div class="success-response">
                                        <h5>요청 경로: ${requestedPath}</h5>
                                        <div class="response-info">
                                            <span class="status-badge status-${response.status >= 400 ? 'error' : 'success'}">
                                                ${response.status} ${response.statusText}
                                            </span>
                                            <span class="content-type">Content-Type: ${response.headers['content-type'] || 'N/A'}</span>
                                            <span class="content-length">Content-Length: ${response.body.length}</span>
                                        </div>
                                        
                                        <div class="request-info">
                                            <h6>요청 정보</h6>
                                            <div class="info-grid">
                                                <span class="info-item">
                                                    <strong>Method:</strong> ${response.headers['x-request-method'] || 'N/A'}
                                                </span>
                                                <span class="info-item">
                                                    <strong>Path:</strong> ${response.headers['x-request-path'] || 'N/A'}
                                                </span>
                                                <span class="info-item">
                                                    <strong>QueryString:</strong> ${response.headers['x-query-string'] || '없음'}
                                                </span>
                                            </div>
                                        </div>
                                        
                                        <div class="parameters-info" id="parametersInfo">
                                            ${generateParametersInfo(response.headers)}
                                        </div>
                                        <pre class="http-response"><code>${escapeHtml(httpResponse)}</code></pre>
                                    </div>
                                `;
    }

    // HTML 이스케이프 함수
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // 파라미터 정보 생성 함수
    function generateParametersInfo(headers) {
        const paramHeaders = [];
        
        // X- 로 시작하는 모든 헤더를 찾기
        for (const [key, value] of Object.entries(headers)) {
            if (key.startsWith('x-') && key !== 'x-request-method' && key !== 'x-request-path' && key !== 'x-query-string') {
                paramHeaders.push({ key: key, value: value });
            }
        }
        
        if (paramHeaders.length > 0) {
            let paramsHtml = '<h6>파라미터 상세</h6><div class="info-grid">';
            
            paramHeaders.forEach(param => {
                const label = param.key.substring(2).charAt(0).toUpperCase() + param.key.substring(3);
                paramsHtml += '<span class="info-item"><strong>' + label + ':</strong> ' + param.value + '</span>';
            });
            
            paramsHtml += '</div>';
            return paramsHtml;
        } else {
            return '';
        }
    }

</script>
</body>
</html>