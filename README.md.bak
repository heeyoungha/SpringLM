## 테스트 코드 작성 및 기능 검증 보완

**목표:** 단순 기능 구현을 넘어서 **테스트 코드로 안정성 확보**

### 🧪 테스트 환경 구축
- **테스트 프로파일**: `application-test.yml`
  - 자동 적용: ./gradlew test 실행 시 application-test.yml이 자동 로드되어 테스트 프로파일 활성화
  - DB: H2 인메모리 데이터베이스 사용, 매 테스트마다 create-drop으로 스키마 초기화
  - JWT: 테스트 전용 시크릿 키 및 1시간 만료 시간 설정
  - 테스트 격리: @DataJpaTest는 각 테스트마다 자동 트랜잭션 롤백으로 완전한 DB 상태 초기화
  - → 별도의 환경 구성 없이 테스트 실행만으로 일관된 환경에서 안정적으로 검증 가능
  
- **테스트 도구**
  - **JUnit 5 (Jupiter)**: 테스트 프레임워크
  - **Spring Boot Test**: `@SpringBootTest`, `@WebMvcTest`
  - **Mockito**: Repository, Service 모킹
  - **H2 Database**: 인메모리 DB 기반 데이터 검증
  - **Testcontainers**: 실제 DB(PostgreSQL/MySQL) 기반 통합 테스트
  - **Jacoco**: 테스트 커버리지 리포트

#### 1) Unit Test (핵심 로직 검증) ✅ **구현 완료**

- **JwtUtilTest**: JWT 토큰 생성/검증/만료 여부/Claims 파싱 검증 (11개 테스트)
- **UserServiceTest**: 사용자 CRUD 및 예외 처리 검증 (10개 테스트)
- **GoogleResponseTest**: OAuth2 응답 파싱 및 null-safe 처리 검증 (8개 테스트)
- **성과**: 총 29개 단위 테스트 작성 → 코드 품질 개선 (버그 수정 & null-safe 강화)

##### **🔧 Unit Test를 통한 실제 코드 품질 개선**

1. **UserService.createUser() 버그 수정**:
   ```java
   // 수정 전: save 반환값을 사용하지 않음 (ID가 null)
   userRepository.save(user);
   return new UserResponse(user);
   
   // 수정 후: save 반환값 사용 (ID 포함된 저장된 엔티티)
   User savedUser = userRepository.save(user);
   return new UserResponse(savedUser);
   ```

2. **JWT 로직 중복 제거 및 단일 책임 원칙 적용**:
   - **기존**: `CustomOAuth2UserService`, `JwtAuthenticationFilter`에 JWT 로직 중복
   - **개선**: `JwtUtil` 클래스로 통합하여 코드 중복 제거
   ```java
   // CustomOAuth2UserService에서 JwtUtil 사용
   return jwtUtil.generateToken(user.getId(), user.getUsername(), user.getEmail(), user.getRole());
   
   // JwtAuthenticationFilter에서 JwtUtil 사용  
   if (token != null && jwtUtil.validateToken(token)) {
       Claims claims = jwtUtil.getClaimsFromToken(token);
   ```

3. **GoogleReponse null 안전성 강화**:
   ```java
   // 수정 전: NullPointerException 위험
   return attribute.get("email").toString();
   
   // 수정 후: null-safe 처리
   attribute.get("email");
   return Optional.ofNullable(attribute.get("email"))
            .map(Object::toString())
            .orElse(null);
   ```

---

#### 2) Repository Layer 테스트 (Data Layer 안정성 검증) ✅ **구현 완료**

- **UserRepository 테스트**: `UserRepositoryTest.java` (9개 테스트)
  - `@DataJpaTest` 어노테이션 활용
  - `@BeforeEach`로 공통 테스트 데이터 준비
  - 사용자 저장, 조회, 수정, 삭제(Soft Delete) 검증
  - 커스텀 쿼리 메소드(`findByEmail()`, `findByUsername()`) 검증
  - 중복 이메일 저장 및 여러 사용자 관리 테스트

- **BoardRepository 테스트**: `BoardRepositoryTest.java` (9개 테스트)
  - 게시판 CRUD 기본 동작 검증
  - 제목 검색 기능(`findByTitleContaining()`) 및 페이징 테스트
  - H2 데이터베이스 대소문자 구분 특성 반영한 검색 테스트
  - 게시판과 댓글 연관관계 검증
  - Soft Delete 동작 확인

- **ReplyRepository 테스트**: `ReplyRepositoryTest.java` (9개 테스트)
  - 댓글 CRUD 기본 동작 검증
  - 게시판-댓글, 사용자-댓글 연관관계 테스트
  - Cascade 및 OrphanRemoval 동작 검증
  - 댓글 내용 길이 제한(120자) 테스트
  - 여러 댓글 관리 및 수정 기능 검증

##### **🔧 Repository Layer 테스트 전략**

1. **@BeforeEach 활용으로 테스트 효율성 향상**:
   ```java
   @BeforeEach
   void setUp() {
       // 공통 테스트 데이터를 한 번에 준비
       testUser = userRepository.save(createTestUser());
       testBoard = boardRepository.save(createTestBoard());
   }
   ```

2. **실제 데이터베이스 동작 반영**:
   - H2 데이터베이스의 대소문자 구분 특성을 고려한 검색 테스트
   - JPA 연관관계, Cascade, OrphanRemoval 등의 실제 동작 검증

**성과**: 총 27개 Repository 테스트 작성 → Data Layer 안정성 확보

---

#### 3) Web Layer + Security / JWT 통합 검증 ✅ **구현 완료**

**목적**: 운영 환경과 유사하게 Security, JWT 필터, Controller 연동 동작 검증
**특징**: `@SpringBootTest` + `@AutoConfigureMockMvc` 사용, SecurityConfig와 JwtAuthenticationFilter 포함 → 실제 요청 흐름 검증

- **SecurityConfig 테스트**: `SecurityConfigTest.java` (4개 테스트) ✅
  - 공개/보호된 엔드포인트 접근 제어
  - OAuth2 로그인 엔드포인트 접근 가능 여부

- **JwtAuthenticationFilter 테스트**: `JwtAuthenticationFilterTest.java` (3개 테스트) ✅
  - 유효한 JWT → 인증 성공
  - 잘못된 JWT → 인증 실패
  - JWT 토큰 없이 접근 시 인증 실패

- **BoardApiController 테스트**: `BoardApiControllerTest.java` (2개 테스트) ✅
  - 인증된 사용자 API 접근
  - 비인증 사용자 API 접근 제한

**장점**: 운영 환경과 거의 동일한 테스트 환경 재현, Security/Filter/Controller 통합 흐름 검증 가능

##### **🔧 Web Layer 테스트 전략**

1. **통합 테스트**:
   ```java
   @SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
   @AutoConfigureMockMvc
   @ActiveProfiles("test")
   class SecurityConfigTest {
       // SecurityConfig와 JwtAuthenticationFilter 포함 → 실제 요청 흐름 검증
   }
   ```

2. **Security 테스트**:
   ```java
   @WithMockUser(username = "testuser", roles = "USER")
   void authenticatedUserAccess() throws Exception {
       // 인증된 사용자 시뮬레이션
   }
   ```

3. **MockMvc를 통한 HTTP 테스트**:
   ```java
   mockMvc.perform(get("/boardList"))
           .andExpect(status().isOk())
           .andExpect(view().name("board/get-boardlist"));
   ```

**성과**: 총 9개 Web Layer 핵심 테스트 작성 → Security & Controller 안정성 확보

---

#### 4) Integration Test & End-to-End 테스트 (전체 플로우 검증) ✅ **구현 완료**

1. **OAuth2 통합 테스트**: `OAuth2IntegrationTest.java` (3개 테스트)
   - `@SpringBootTest(webEnvironment = RANDOM_PORT)`
   - MockWebServer로 Google OAuth2 API 모킹
   - 전체 인증 플로우: OAuth2 로그인 → JWT 토큰 발급 → Claims 검증
   - JWT 토큰 생성/검증 로직 통합 검증

2. **API 통합 테스트**: `AuthenticationIntegrationTest.java` (6개 테스트) ✅
   - **현재 이슈**: Soft Delete 동작 문제로 삭제 후 목록 조회 시 개수 확인 테스트 실패
   - **해결 방안**: BoardService.deleteBoard()에서 flush() 호출 추가 또는 404 응답으로 삭제 확인   - TestContainers로 실제 MySQL DB 연결
   - 전체 CRUD 플로우: 로그인 → JWT 발급 → 게시판 생성/조회/수정/삭제
   - 인증된 API 호출 및 권한 검증
   - Soft Delete 동작 검증

3. **환경변수 테스트**: `EnvironmentConfigTest.java` (3개 테스트) ✅
   - `.env` 파일 로딩 및 Spring 프로퍼티 바인딩 검증
   - 환경별 설정 분리 검증

**성과**: 총 12개 통합 테스트 작성 → 전체 애플리케이션 플로우 안정성 확보

##### **🔧 Integration Test 전략**

1. **TestContainers 활용**:
   ```java
   @Container
   @ServiceConnection
   static MySQLContainer<?> mysqlContainer = new MySQLContainer<>("mysql:8.0")
           .withDatabaseName("testdb")
           .withUsername("test")
           .withPassword("test")
           .withReuse(true);
   ```

2. **MockWebServer 활용**:
   ```java
   MockWebServer mockWebServer = new MockWebServer();
   mockWebServer.start();
   // Google OAuth2 API 모킹
   ```

3. **실제 DB 기반 테스트**:
   ```java
   @SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
   @Testcontainers
   @ActiveProfiles("test")
   class AuthenticationIntegrationTest {
       // 실제 MySQL DB와 연동하여 전체 플로우 검증
   }
   ```

**장점**: 운영 환경과 거의 동일한 테스트 환경 재현, 실제 DB 연동으로 데이터 무결성 검증 가능

---

### 🛠 테스트에서 활용한 Spring 기술 스택

#### **🧪 테스트 프레임워크 & 라이브러리**
- **JUnit 5 (Jupiter)**: 단위/통합 테스트 프레임워크
  - `@Test`, `@DisplayName`, `@BeforeEach` - 테스트 메서드 및 설정
  - `@ExtendWith(MockitoExtension.class)` - Mockito 통합 (순수 Unit Test)
- **Mockito**: Mock 객체 생성 및 검증
  - `@Mock` - Repository 등 의존성 Mock 생성 (`UserRepository`)
  - `@InjectMocks` - 테스트 대상 객체에 Mock 주입 (`UserService`, `JwtUtil`)
  - `given().willReturn()` - Mock 동작 정의 (BDD 스타일)
  - `then().should()` - Mock 호출 검증
  - `willAnswer()` - 동적 Mock 응답 설정 (ID 생성 시뮬레이션)
  - `never()` - 메서드 호출되지 않음 검증
- **AssertJ**: 유창한 검증 API 
  - `assertThat()` - 값 검증, `isEqualTo()`, `isNotNull()`, `hasSize()`
  - `assertThatThrownBy()` - 예외 발생 검증
  - `assertThatCode()` - 예외 미발생 검증

#### **🍃 Spring Test 관련 기술**
- **Spring Test Utils**: 
  - `ReflectionTestUtils.setField()` - `@Value` private 필드 주입 (Unit Test에서 사용)
- **Spring Boot Test**:
  - `@SpringBootTest` - 통합 테스트용 (전체 ApplicationContext 로드)
  - `@ExtendWith(MockitoExtension.class)` - 순수 Unit Test (Context 로드 없이 빠른 실행)
  - `@Disabled` - 특정 테스트 비활성화 (통합 테스트 제외)
- **Test Profile 설정**:
  - `src/test/resources/application-test.yml` - 테스트 전용 설정 파일
  - `spring.profiles.active: test` - 테스트 프로파일 활성화
  - `systemProperty("spring.profiles.active", "test")` - Gradle 테스트 태스크 설정

#### **🌐 Spring Web & Security 테스트**
- **Spring Security Test**:
  - `@WithMockUser` - 인증된 사용자 시뮬레이션
  - `@WithAnonymousUser` - 익명 사용자 시뮬레이션
  - `@WithUserDetails` - 사용자 상세 정보 기반 인증
- **Spring MVC Test**:
  - `@AutoConfigureMockMvc` - MockMvc 자동 설정
  - `MockMvc` - HTTP 요청/응답 테스트
  - `MockMvcRequestBuilders` - HTTP 요청 빌더
  - `MockMvcResultMatchers` - HTTP 응답 검증
- **Spring Boot Test**:
  - `@SpringBootTest(webEnvironment = RANDOM_PORT)` - 실제 서버 포트로 통합 테스트
  - `@SpringBootTest(webEnvironment = MOCK)` - Mock 웹 환경으로 테스트

#### **💾 테스트 데이터베이스**
- **H2 Database**: 
  - `jdbc:h2:mem:testdb` - 인메모리 테스트 DB
  - `ddl-auto: create-drop` - 테스트 시작/종료 시 스키마 생성/삭제
  - `DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE` - 테스트 간 DB 연결 유지
  - `show-sql: false` - 테스트 로그 최소화
- **Spring Data JPA Test**:
  - `@DataJpaTest` - JPA 관련 Bean만 로드하여 빠른 테스트
  - `@Transactional` - 자동 트랜잭션 롤백으로 테스트 격리

#### **🔐 테스트 보안 설정**
- **OAuth2 Test Configuration**: 
  - `test_google_client_id`, `test_google_client_secret` - 테스트용 더미 값
- **JWT Test Configuration**: 
  - `test_jwt_secret_key_for_testing_64_chars_minimum_required_for_hs512_algorithm` - HS512 알고리즘용 64바이트 이상 키
  - `expiration: 3600000` - 테스트용 1시간 만료 시간
- **Logging Configuration**: 
  - `root: WARN`, `com.example.springlm: INFO` - 테스트 로그 레벨 최적화

---

## 📊 테스트 커버리지 리포트 (Jacoco)

### **테스트 실행 및 커버리지 리포트 생성**

```bash
# 모든 테스트 실행
./gradlew test

# Jacoco 커버리지 리포트 생성
./gradlew jacocoTestReport

# 테스트 실행 + 커버리지 리포트 생성 (한 번에)
./gradlew clean test jacocoTestReport
```

### **📁 리포트 파일 위치**

```
build/
├── jacocoHtml/           # HTML 형식 커버리지 리포트
│   ├── index.html       # 메인 리포트 페이지
│   └── com.example.springlm.*/  # 패키지별 상세 리포트
├── jacoco/              # 바이너리 커버리지 데이터
│   └── test.exec        # 테스트 실행 데이터
└── reports/tests/test/  # 테스트 실행 결과
    └── index.html       # 테스트 결과 리포트
```

### **🌐 리포트 확인 방법**

1. **브라우저에서 HTML 리포트 열기:**
   ```
   file:///[프로젝트경로]/build/jacocoHtml/index.html
   ```

2. **macOS에서 바로 열기:**
   ```bash
   open build/jacocoHtml/index.html
   ```

3. **리포트에서 확인할 수 있는 정보:**
   - **패키지별 커버리지**: 각 패키지의 라인/브랜치 커버리지 비율
   - **클래스별 상세 분석**: 메서드별 커버리지 현황
   - **소스코드 하이라이팅**: 테스트된/안된 코드 구분 표시
   - **커버리지 통계**: 전체 프로젝트 커버리지 요약

### **📈 커버리지 목표 설정**

`build.gradle`에서 최소 커버리지 비율 설정:

```gradle
jacocoTestCoverageVerification {
    violationRules {
        rule {
            limit {
                minimum = 0.80  // 80% 이상 커버리지 목표
            }
        }
    }
}
```

### **✅ 현재 구현된 테스트들**

#### **🧪 Unit Test Layer (29개 테스트)**
- **🔐 JwtUtilTest**: JWT 토큰 생성/검증/파싱 로직 (11개 테스트)
- **👤 UserServiceTest**: 사용자 CRUD 비즈니스 로직 (10개 테스트)
- **🌐 GoogleResponseTest**: OAuth2 응답 데이터 변환 (8개 테스트)

#### **🗄️ Repository Layer (27개 테스트)**
- **👤 UserRepositoryTest**: 사용자 데이터 접근 계층 (9개 테스트)
- **📝 BoardRepositoryTest**: 게시판 데이터 접근 계층 (9개 테스트)
- **💬 ReplyRepositoryTest**: 댓글 데이터 접근 계층 (9개 테스트)

#### **🌐 Web Layer (9개 테스트)**
- **🛡️ SecurityConfigTest**: 보안 설정 및 접근 제어 (4개 테스트)
- **🔑 JwtAuthenticationFilterTest**: JWT 인증 필터 (3개 테스트)
- **📝 BoardApiControllerTest**: 게시판 API 컨트롤러 (2개 테스트)

#### **🔗 Integration Test Layer (12개 테스트)**
- **🔐 OAuth2IntegrationTest**: OAuth2 통합 테스트 (3개 테스트)
- **🌐 AuthenticationIntegrationTest**: API 통합 테스트 (6개 테스트)
- **⚙️ EnvironmentConfigTest**: 환경변수 테스트 (3개 테스트)

### **🚀 테스트 실행 명령어**

```bash
# 특정 테스트 클래스만 실행
./gradlew test --tests "JwtUtilTest"
./gradlew test --tests "UserServiceTest"
./gradlew test --tests "GoogleResponseTest"
./gradlew test --tests "UserRepositoryTest"
./gradlew test --tests "BoardRepositoryTest"
./gradlew test --tests "ReplyRepositoryTest"
./gradlew test --tests "SecurityConfigTest"
./gradlew test --tests "JwtAuthenticationFilterTest"
./gradlew test --tests "BoardApiControllerTest"
./gradlew test --tests "OAuth2IntegrationTest"
./gradlew test --tests "AuthenticationIntegrationTest"
./gradlew test --tests "EnvironmentConfigTest"

# Integration Test 실행
./gradlew test --tests "*IntegrationTest*"          # 모든 Integration Test

# 레이어별 테스트 실행
./gradlew test --tests "*Test"                    # 모든 Unit Test
./gradlew test --tests "*RepositoryTest"          # 모든 Repository Test
./gradlew test --tests "*ConfigTest"              # 모든 Config Test
./gradlew test --tests "*FilterTest"              # 모든 Filter Test
./gradlew test --tests "*ApiControllerTest"       # 모든 API Controller Test

# 전체 테스트 실행
./gradlew test                                     # 모든 테스트 실행
./gradlew clean test                              # 클린 빌드 후 테스트

# 테스트 프로파일로 애플리케이션 실행
./gradlew bootRunTest

# 커버리지 리포트 생성
./gradlew jacocoTestReport                        # 커버리지 리포트 생성
./gradlew clean test jacocoTestReport            # 테스트 + 커버리지 리포트
./gradlew jacocoTestCoverageVerification         # 커버리지 검증 (80% 이상)
```
